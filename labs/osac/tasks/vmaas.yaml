---
- name: "Fetch the kubeconfig for the VMaaS cluster"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ vmaas_clusters[0] }}-admin-kubeconfig"
    namespace: "{{ vmaas_clusters[0] }}"
  register: __vmaas_cluster_kubeconfig
  retries: 10
  delay: 5
  until:
    - __vmaas_cluster_kubeconfig.resources | length > 0
    - __vmaas_cluster_kubeconfig.resources[0].data.kubeconfig is defined

- name: Configure Ansible Automation Platform
  vars:
    aap_name: "osac-aap"
    aap_ns: "ansible-aap"
    aap_controller_name: "{{ aap_name }}-controller"
    aap_token_description: "OSAC Operator Token"
    aap_token_overwrite: false
    aap_api_path: "/api/v2"
    aap_api_user: "admin"
    aap_api_validate_certs: false
  block:

    - name: "Create AAP namespace"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ aap_ns }}"

    - name: "Create kubeconfig secret for the VMaaS cluster (aap namespace)"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ aap_kubeconfig_secret_name | default('vmaas-cluster-kubeconfig') }}"
            namespace: "{{ aap_ns }}"
          type: Opaque
          data:
            kubeconfig: "{{ __vmaas_cluster_kubeconfig.resources[0].data.kubeconfig }}"

    - name: "Create AAP config secret for Config as Code"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('ansible.builtin.template', '../templates/aap-config.yaml.j2') | from_yaml }}"
      register: __r_create_aap_config
      retries: 10
      delay: 5
      until: __r_create_aap_config is success

    - name: "Create AnsibleAutomationPlatform resource"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('ansible.builtin.template', '../templates/aap.yaml.j2') | from_yaml }}"
      register: __r_deploy_aap
      retries: 10
      delay: 5
      until: __r_deploy_aap is success

    - name: "Get AAP Controller Route URL"
      kubernetes.core.k8s_info:
        api_version: route.openshift.io/v1
        kind: Route
        namespace: "{{ aap_ns }}"
        name: "{{ aap_controller_name }}"
      register: __aap_route
      retries: 30
      delay: 10
      until: __aap_route.resources | length > 0

    - name: Set AAP URL Fact
      ansible.builtin.set_fact:
        osac_aap_url: "https://{{ __aap_route.resources[0].spec.host }}"

    - name: "Get AAP admin password"
      kubernetes.core.k8s_info:
        kind: Secret
        namespace: "{{ aap_ns }}"
        name: "{{ aap_controller_name }}-admin-password"
      register: __aap_admin_password_secret
      retries: 5
      delay: 10
      until:
        - __aap_admin_password_secret.resources | length > 0
        - __aap_admin_password_secret.resources[0].data.password is defined
      no_log: true

    - name: "Debug AAP admin password secret"
      ansible.builtin.debug:
        msg: "AAP admin password secret: {{ __aap_admin_password_secret }}"

    - name: "Set AAP admin password fact"
      ansible.builtin.set_fact:
        __aap_admin_password: "{{ __aap_admin_password_secret.resources[0].data.password | b64decode }}"
      no_log: true

    - name: "Debug AAP admin password"
      ansible.builtin.debug:
        msg: "AAP admin password: {{ __aap_admin_password }}"

    - name: "Query AAP API for Admin User ID"
      ansible.builtin.uri:
        url: "{{ osac_aap_url }}{{ aap_api_path }}/users/?username={{ aap_api_user }}"
        method: GET
        user: "{{ aap_api_user }}"
        password: "{{ __aap_admin_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_api_validate_certs }}"
        return_content: true
      register: __aap_user_response
      retries: 30
      delay: 10
      until:
        - __aap_user_response.json is defined
        - __aap_user_response.json.results is defined
        - __aap_user_response.json.results | length > 0
        - __aap_user_response.json.results[0].id is defined

    - name: "Check if osac-config secret already exists"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "{{ osac_config_name | default('osac-config') }}"
        namespace: "{{ osac_operator_ns | default('osac-operator-system') }}"
      register: __aap_osac_config_secret

    - name: "Check if OSAC token already exists in AAP"
      ansible.builtin.uri:
        url: "{{ osac_aap_url }}{{ aap_api_path }}/users/{{ __aap_user_response.json.results[0].id }}/personal_tokens/?description={{ aap_token_description | urlencode }}"
        method: GET
        user: "{{ aap_api_user }}"
        password: "{{ __aap_admin_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_api_validate_certs }}"
        return_content: true
      register: __aap_existing_tokens_response

    # We can list the tokens, but we cannot retrieve the value of a existing token, so we
    # have to delete the token to allow rotation. It's controlled by the aap_token_overwrite variable.
    - name: "Delete existing OSAC token(s) to allow rotation"
      ansible.builtin.uri:
        url: "{{ osac_aap_url }}{{ aap_api_path }}/tokens/{{ item.id }}/"
        method: DELETE
        user: "{{ aap_api_user }}"
        password: "{{ __aap_admin_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_api_validate_certs }}"
        status_code: 204
      loop: "{{ __aap_existing_tokens_response.json.results }}"
      loop_control:
        label: "Deleting old token ID: {{ item.id }}"
      when:
        - __aap_existing_tokens_response.json.count > 0
        - (aap_token_overwrite | bool or __aap_osac_config_secret.resources | length == 0)

    - name: "Generate Personal Access Token via REST API"
      ansible.builtin.uri:
        url: "{{ osac_aap_url }}{{ aap_api_path }}/users/{{ __aap_user_response.json.results[0].id }}/personal_tokens/"
        method: POST
        user: "{{ aap_api_user }}"
        password: "{{ __aap_admin_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_api_validate_certs }}"
        body_format: json
        body:
          description: "{{ aap_token_description }}"
          scope: "write"
        status_code: 201  # AAP returns 201 Created on success
        return_content: true
      register: __aap_token_response
      no_log: true
      when: >
        __aap_existing_tokens_response.json.count == 0 or
        __aap_osac_config_secret.resources | length == 0 or
        aap_token_overwrite | bool

    - name: "Set osac aap token fact"
      ansible.builtin.set_fact:
        osac_aap_token: "{{ __aap_token_response.json.token }}"
      no_log: true
      when: >
        __aap_existing_tokens_response.json.count == 0 or
        __aap_osac_config_secret.resources | length == 0 or
        aap_token_overwrite | bool

    - name: "Prepare aap license for base64 encoding"
      ansible.builtin.slurp:
        src: "{{ aap_license_file }}"
      register: __aap_b64_license

    - name: "Create Secret config-as-code-manifest-ig"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: config-as-code-manifest-ig
            namespace: "{{ aap_ns }}"
          type: Opaque
          data:
            "license.zip": "{{ __aap_b64_license.content }}"

    - name: "Create aap-bootstrap job"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('ansible.builtin.template', '../templates/aap-bootstrap.yaml.j2') | from_yaml }}"
      register: __r_create_aap_bootstrap
      retries: 10
      delay: 5
      until: __r_create_aap_bootstrap is success

- name: Deploy OSAC
  become: true
  vars:
    osac_operator_manifests: "{{ osac_operator.image }}:{{ osac_operator.tag }}-manifests"
  block:

    - name: "Create OSAC operator namespace"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ osac_operator_ns | default('osac-operator-system') }}"

    # If the AAP token is NOT defined, and it happens if the token was previously
    # created on an earlier run, we avoid creating the osac config secret
    - name: "Create osac config secret"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('ansible.builtin.template', '../templates/osac-config.yaml.j2') | from_yaml }}"
      register: __r_create_osac_config
      retries: 10
      delay: 5
      until: __r_create_osac_config is success
      when: osac_aap_token is defined

    - name: "Create kubeconfig secret for the VMaaS cluster (osac namespace)"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ osac_kubeconfig_secret_name | default('vmaas-cluster-kubeconfig') }}"
            namespace: "{{ osac_operator_ns | default('osac-operator-system') }}"
          type: Opaque
          data:
            kubeconfig: "{{ __vmaas_cluster_kubeconfig.resources[0].data.kubeconfig }}"

    - name: "Pull OSAC operator container image"
      containers.podman.podman_image:
        name: "{{ osac_operator_manifests }}"
        state: present
      register: __r_podman_pull
      retries: 3
      delay: 10
      until: __r_podman_pull is success

    - name: "Mount the container filesystem"
      ansible.builtin.command:
        cmd: "podman image mount {{ osac_operator_manifests }}"
      changed_when: false
      register: __r_mount_path

    - name: "Apply manifests from mounted container"
      kubernetes.core.k8s:
        state: present
        src: "{{ __r_mount_path.stdout.strip() }}/manifests/install.yaml"
      register: __r_apply_manifests
      retries: 6
      delay: 5
      until: __r_apply_manifests is success

    - name: "Fetch OSAC Operator Deployment"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ osac_operator_name | default('osac-operator') }}-controller-manager"
        namespace: "{{ osac_operator_ns | default('osac-operator-system') }}"
      register: __osac_deploy
      retries: 30
      delay: 10
      until: __osac_deploy.resources | length > 0

    - name: "Patch the OSAC Operator Deployment adding kubeconfig volume"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ osac_operator_name | default('osac-operator') }}-controller-manager"
            namespace: "{{ osac_operator_ns | default('osac-operator-system') }}"
          spec:
            template:
              spec:
                containers:
                  - name: "{{ __osac_deploy.resources[0].spec.template.spec.containers[0].name }}"
                    image: "{{ __osac_deploy.resources[0].spec.template.spec.containers[0].image }}"
                    volumeMounts:
                      - name: "vmaas-cluster-kubeconfig"
                        mountPath: "/var/run/secrets/vmaas-cluster"
                        readOnly: true
                volumes:
                  - name: "vmaas-cluster-kubeconfig"
                    secret:
                      secretName: "{{ osac_kubeconfig_secret_name | default('vmaas-cluster-kubeconfig') }}"
      when: __osac_deploy.resources | length > 0

  always:
    - name: "Unmount the container filesystem"
      ansible.builtin.command:
        cmd: "podman image umount {{ osac_operator_manifests }}"
      changed_when: false
      when:
        - __r_mount_path is defined
        - __r_mount_path.stdout is defined
        - __r_mount_path.stdout | length > 0
